<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>GitHub Chat Working</title>
    <style>
        body { font-family: sans-serif; max-width: 500px; margin: 20px auto; padding: 0 10px; }
        #messages { height: 350px; overflow-y: auto; border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; background: #fff; border-radius: 8px; }
        .msg { margin-bottom: 10px; line-height: 1.4; border-bottom: 1px solid #f0f0f0; padding-bottom: 5px; }
        input { padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #218838; }
    </style>
</head>
<body>
    <h3>Чат: Firebase + GitHub Pages</h3>
    <div id="messages">Загрузка сообщений...</div>
    
    <div style="display: flex; gap: 5px;">
        <input type="text" id="nameInput" placeholder="Имя" style="width: 80px;">
        <input type="text" id="messageInput" placeholder="Сообщение..." style="flex-grow: 1;">
        <button id="sendBtn">ОК</button>
    </div>

    <script type="module">
        // Используем CDN, который точно работает с type="module"
        import { initializeApp } from "https://www.gstatic.com";
        import { getDatabase, ref, push, onChildAdded } from "https://www.gstatic.com";

        const firebaseConfig = {
            apiKey: "AIzaSyBQ8AVQ1D8c0IpDgoRXL0QayaaVktd3_Xg",
            authDomain: "gitchat-2b675.firebaseapp.com",
            databaseURL: "https://gitchat-2b675-default-rtdb.firebaseio.com",
            projectId: "gitchat-2b675",
            appId: "1:1021059658961:web:e455940894ca49673481f0"
        };

        // Инициализация
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const chatRef = ref(db, "messages");

        const msgContainer = document.getElementById("messages");
        const nameInp = document.getElementById("nameInput");
        const msgInp = document.getElementById("messageInput");
        const btn = document.getElementById("sendBtn");

        // Очищаем надпись "Загрузка" при первом получении данных
        let firstLoad = true;

        onChildAdded(chatRef, (snapshot) => {
            if (firstLoad) {
                msgContainer.innerHTML = "";
                firstLoad = false;
            }
            const data = snapshot.val();
            const div = document.createElement("div");
            div.className = "msg";
            div.innerHTML = `<b>${data.name || "Аноним"}</b>: ${data.text}`;
            msgContainer.appendChild(div);
            msgContainer.scrollTop = msgContainer.scrollHeight;
        });

        // Отправка
        btn.onclick = () => {
            const text = msgInp.value.trim();
            if (text) {
                push(chatRef, {
                    name: nameInp.value || "Аноним",
                    text: text,
                    timestamp: Date.now()
                }).catch(e => alert("Ошибка! Проверь Rules в Firebase: " + e.message));
                msgInp.value = "";
            }
        };
    </script>
</body>
</html>
