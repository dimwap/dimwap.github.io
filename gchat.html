<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ì–æ—Å—Ç–µ–≤–∞—è –∫–Ω–∏–≥–∞-—á–∞—Ç —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π –∏ –≥–æ–ª–æ—Å–æ–≤—ã–º –≤–≤–æ–¥–æ–º</title>
    <style>
        body { font-family: sans-serif; max-width: 500px; margin: 20px auto; padding: 10px; }
        #box { height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; background: #fff; }
        .msg { margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .time { color: #999; font-size: 0.8em; }
        .err { color: red; font-size: 0.9em; }
/* –î–ª—è –∫—Ä–∞—Å–æ—Ç—ã */
#auth-container {
    margin-bottom: 0px;
    padding: 0px;
    background: #f8f8f8;
    border-radius: 3px;
}

#auth-container button {
    padding: 5px 10px;
    cursor: pointer;
}
/* –î–æ–±–∞–≤–∏–º —Å—Ç–∏–ª—å –¥–ª—è –≤—Å–ø–ª—ã–≤–∞—é—â–µ–π –ø–æ–¥—Å–∫–∞–∑–∫–∏ */
.msg {
    cursor: help;
    position: relative;
    margin-bottom: 5px;
    padding: 3px 5px;
    border-radius: 3px;
    background: #f0f0f0;
}

.msg:hover {
    background: #e0e0e0;
}

#auth-container a:hover {
    text-decoration: underline;
}
    </style>
</head>
<body>
<script src="firebase/8.10.0/firebase-app.js"></script>
<script src="firebase/8.10.0/firebase-auth.js"></script>
<script src="firebase/8.10.0/config.js?v=2"></script>
<h3>–ì–æ—Å—Ç–µ–≤–∞—è –∫–Ω–∏–≥–∞ v1.2 (Traffic Safe +github Auth +mike)</h3>
<div id="box">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π...</div>
    
<!--div style="display: flex; gap: 5px;">
    <div id="auth-container">
        <button onclick="login()">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ GitHub</button>
    </div>
    <input id="m" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="flex-grow: 1;">
    <button onclick="send()">–û–ö</button>
</div -->
<div style="display: flex; gap: 5px; align-items: center;">
    <!-- –ë–ª–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    <div id="auth-container">
        <button onclick="login()">–í—Ö–æ–¥ —á–µ—Ä–µ–∑ GitHub</button>
    </div>

    <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ -->
    <input id="m" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ (–∏–ª–∏ –≥–æ–ª–æ—Å–æ–ºüé§)..." style="flex-grow: 1;" disabled>

    <!-- –ö–Ω–æ–ø–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞ (–Ω–æ–≤–∞—è) -->
    <button id="voice-btn" type="button" title="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥" style="display: none; padding: 0 10px; font-size: 0.8em; cursor: pointer;" disabled>
        üé§
    </button>

    <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
    <button id="send-btn" onclick="send()" disabled>–û–ö</button>
</div>

<!-- –ù–µ–±–æ–ª—å—à–æ–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å—Ç–∞—Ç—É—Å–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –∏—Å—á–µ–∑–∞–µ—Ç —á–µ—Ä–µ–∑ 2 —Å–µ–∫) -->
<div id="voice-status" style="font-size: 0.8em; color: #666; height: 1.2em; margin-top: 2px;"></div>    
<!-- –°–Ω–∞—á–∞–ª–∞ –∫–æ–Ω—Ñ–∏–≥ -->
<script>
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—Ç–µ–Ω–∫–∞ —Ü–≤–µ—Ç–∞ –∏–∑ —Ö—ç—à–∞ –∏–º–µ–Ω–∏ (—É –∫–∞–∂–¥–æ–≥–æ —Å–≤–æ–π —Ü–≤–µ—Ç)
    function stringToColor(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            hash = str.charCodeAt(i) + ((hash << 5) - hash);
        }
        const h = Math.abs(hash) % 360; // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–Ω –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ [0, 360]
        return `hsl(${h}, 70%, 85%)`;
    }
    //require('dotenv').config();
    //const dbUser = process.env.apiKey;
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    const firebaseConfig = getHeaders();
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

    const base = firebaseConfig.databaseURL + "/test.json";
    let userToken = null;
    let userName = "–ê–Ω–æ–Ω–∏–º";
    let lastTs = 0;
    let isFirstLoad = true;
    let isSignedOut = false; // –§–ª–∞–≥ –≤—ã—Ö–æ–¥–∞, –æ–±—Ö–æ–¥ –ø—Ä–æ–±–ª–µ–º–∫–∏

    //<!-- –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π –±–ª–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    firebase.auth().onAuthStateChanged(async (user) => {
        const authContainer = document.getElementById("auth-container");
        const messageInput = document.getElementById("m");
        const sendButton = document.querySelector("button[onclick='send()']");
    
        if (user) {
            isSignedOut = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ø—Ä–∏ –≤—Ö–æ–¥–µ
            userToken = await user.getIdToken();
            userName = user.displayName || user.email.split('@')[0];
            
            authContainer.innerHTML = `
                <a href="#" onclick="handleSignOut()" 
                   style="text-decoration: none; color: inherit; cursor: pointer;"
                   title="–ö–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –≤—ã—Ö–æ–¥–∞">
                    ${escape(userName)}
                </a>
            `;
            
            messageInput.disabled = false;
            sendButton.disabled = false;
        } else {
            authContainer.innerHTML = `
                <button onclick="login()">
                    –í—Ö–æ–¥ —á–µ—Ä–µ–∑ GitHub
                </button>
            `;
            
            messageInput.disabled = true;
            sendButton.disabled = true;
        }
    });

    async function login() {
        const provider = new firebase.auth.GithubAuthProvider();
        try {
            await firebase.auth().signInWithPopup(provider);
        } catch (e) {
            alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: " + e.message);
        }
    }

    async function load() {
        // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è REST
        let params = isFirstLoad 
            ? `orderBy="ts"&limitToLast=10` 
            : `orderBy="ts"&startAt=${lastTs + 1}`;

        const url = `${base}?${params}`;

        try {
            const res = await fetch(url);
            if (!res.ok) {
                const err = await res.json();
                console.warn("Firebase busy/restricted:", err.error);
                return;
            }
            const data = await res.json();
            const box = document.getElementById("box");

            if (data && typeof data === 'object') {
                if (isFirstLoad) { box.innerHTML = ""; isFirstLoad = false; }
            const sortedIds = Object.keys(data).sort((a, b) => data[a].ts - data[b].ts);
            sortedIds.forEach(id => {
                const d = data[id];
                if (!d || !d.ts || d.ts <= lastTs) return;
                
                const div = document.createElement("div");
                div.className = "msg";
                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ü–≤–µ—Ç —Ñ–æ–Ω–∞ –∏—Å—Ö–æ–¥—è –∏–∑ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -- –≤—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏
                const userName = d.name || 'Anonymous';
                const bgColor = stringToColor(userName);
                div.className.backgroundColor = bgColor;
                const time = new Date(d.ts).toLocaleTimeString();
                const date = new Date(d.ts).toLocaleDateString();
                
                // –ü–µ—Ä–µ–Ω–æ—Å–∏–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤ title
                div.title = `${date} ${time} | ${escape(d.name || 'Anonymous')}`;
                div.innerHTML = escape(d.text); // –¢–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
                
                box.appendChild(div);
                lastTs = d.ts;
            });
            box.scrollTop = box.scrollHeight;
            }
        } catch (e) { console.error("Network error"); }
    }
// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã—Ö–æ–¥–∞
function handleSignOut() {
    firebase.auth().signOut().then(() => {
        isSignedOut = true;
        document.getElementById("m").disabled = true;
        document.querySelector("button").disabled = true;
    });
    return false; // –û—Ç–º–µ–Ω—è–µ–º –¥–µ–π—Å—Ç–≤–∏–µ —Å—Å—ã–ª–∫–∏
}
// –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ —á–∞—Ç (–∏ –≤ –±–∞–∑—É rtdb) —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π –∏ –º–µ—Ç–∫–æ–π –≤—Ä–µ–º–µ–Ω–∏ [ts]
    async function send() {
        let text = document.getElementById("m").value;
        if (!text.trim()) return;
        if (!userToken) { alert("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ GitHub!"); return; }
        if (isSignedOut || !firebase.auth().currentUser) {alert('–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É'); return; }
        try {
            const res = await fetch(`${base}?auth=${userToken}`, {
                method: 'POST',
                body: JSON.stringify({
                    name: userName,
                    text: text,
                    ts: Date.now()
                })
            });
            if (!res.ok) throw new Error();
            document.getElementById("m").value = "";
            load();
        } catch (e) { alert("–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ –±–≤–∑—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Rules!"); }
    }

    function escape(str) {
        if (!str) return "";
        return String(str).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }

    setInterval(load, 12000);
    load();
</script>
<script> // —Ñ—É–Ω–∫—Ü–∏—é –ø—Ä–∏–¥—É–º–∞–ª –ò–ò, –ø—Ä–æ—Å—Ç–æ –≤—Å—Ç–∞–≤–ª—è—é
document.addEventListener('DOMContentLoaded', () => {
    const voiceBtn = document.getElementById('voice-btn');
    const inputField = document.getElementById('m');
    const statusDiv = document.getElementById('voice-status');
    const sendBtn = document.getElementById('send-btn');

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ API
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    if (SpeechRecognition) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É, –µ—Å–ª–∏ –±—Ä–∞—É–∑–µ—Ä –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç
        voiceBtn.style.display = 'inline-block';
        
        const recognition = new SpeechRecognition();
        recognition.lang = 'ru-RU'; // –†—É—Å—Å–∫–∏–π —è–∑—ã–∫
        recognition.interimResults = false; // –ñ–¥–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ñ—Ä–∞–∑—ã
        recognition.maxAlternatives = 1;

        let isListening = false;

        // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–∫–∏
        function toggleListening() {
            if (isListening) {
                recognition.stop();
            } else {
                // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –ø–µ—Ä–µ–¥ –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å—å—é? (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) -- —ç—Ç–æ –Ω–∞–º –Ω–µ –Ω—É–∂–Ω–æ=)
                //if (inputField.value.trim() === "") { }
                recognition.start();
            }
        }

        voiceBtn.addEventListener('click', toggleListening);

        // –ù–∞—á–∞–ª–æ –∑–∞–ø–∏—Å–∏
        recognition.onstart = () => {
            isListening = true;
            voiceBtn.textContent = "üõë"; // –ò–∫–æ–Ω–∫–∞ —Å—Ç–æ–ø
            voiceBtn.style.color = "red";
            statusDiv.textContent = "–°–ª—É—à–∞—é... –≥–æ–≤–æ—Ä–∏—Ç–µ.";
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤–æ –≤—Ä–µ–º—è –∑–∞–ø–∏—Å–∏, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞—Ç—å
            inputField.placeholder = "–ì–æ–≤–æ—Ä–∏—Ç–µ...";
        };

        // –ö–æ–Ω–µ—Ü –∑–∞–ø–∏—Å–∏
        recognition.onend = () => {
            isListening = false;
            voiceBtn.textContent = "üé§"; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω
            voiceBtn.style.color = ""; 
            statusDiv.textContent = "";
            inputField.placeholder = "–°–æ–æ–±—â–µ–Ω–∏–µ (–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ üé§)...";
            
            // –§–æ–∫—É—Å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –ø–æ–ª–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            inputField.focus();
        };

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            
            // –í—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –≤ –ø–æ–ª–µ.  –ê –í–û–¢ –≠–¢–û –ù–£–ñ–ù–û! =))
            // –ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –¥–æ–±–∞–≤–ª—è—Ç—å –∫ —É–∂–µ –Ω–∞–ø–∏—Å–∞–Ω–Ω–æ–º—É, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: inputField.value += " " + transcript;
            inputField.value += " " + transcript; 
            
            // –≠–º—É–ª—è—Ü–∏—è —Å–æ–±—ã—Ç–∏—è input (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å —Å–ª—É—à–∞—Ç–µ–ª–∏ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞)
            inputField.dispatchEvent(new Event('input'));
            
            console.log("–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥:", transcript);
        };

        recognition.onerror = (event) => {
            console.error("–û—à–∏–±–∫–∞ –≥–æ–ª–æ—Å–∞:", event.error);
            let msg = "–û—à–∏–±–∫–∞: " + event.error;
            if (event.error === 'not-allowed') msg = "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É!";
            statusDiv.textContent = msg;
            isListening = false;
            voiceBtn.textContent = "üé§";
            voiceBtn.style.color = "";
        };
    } else {
        console.warn("Web Speech API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ.");
    }

    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞: —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è disabled —Å–æ—Å—Ç–æ—è–Ω–∏—è
    // –ï—Å–ª–∏ –≤–∞—à–∞ —Ñ—É–Ω–∫—Ü–∏—è login() —Å–Ω–∏–º–∞–µ—Ç disabled —Å input –∏ send-btn, 
    // –Ω–∞–º –Ω—É–∂–Ω–æ —Ç–∞–∫–∂–µ —Å–Ω—è—Ç—å –µ–≥–æ —Å voice-btn.
    
    // –°–æ–∑–¥–∞–µ–º –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –∞—Ç—Ä–∏–±—É—Ç–∞ disabled —É –ø–æ–ª—è –≤–≤–æ–¥–∞
    const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            if (mutation.attributeName === 'disabled') {
                const isDisabled = inputField.disabled;
                voiceBtn.disabled = isDisabled;
                sendBtn.disabled = isDisabled;
                
                if (!isDisabled) {
                    inputField.placeholder = "–°–æ–æ–±—â–µ–Ω–∏–µ (–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ üé§)...";
                }
            }
        });
    });

    observer.observe(inputField, { attributes: true });
});
</script>
</body>
</html>
