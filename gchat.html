<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Гостевая книга-чат с авторизацией</title>
    <style>
        body { font-family: sans-serif; max-width: 500px; margin: 20px auto; padding: 10px; }
        #box { height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; background: #fff; }
        .msg { margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .time { color: #999; font-size: 0.8em; }
        .err { color: red; font-size: 0.9em; }
/* Для красоты */
#auth-container {
    margin-bottom: 10px;
    padding: 5px;
    background: #f8f8f8;
    border-radius: 3px;
}

#auth-container button {
    padding: 5px 10px;
    cursor: pointer;
}
/* Добавим стиль для всплывающей подсказки */
.msg {
    cursor: help;
    position: relative;
    margin-bottom: 5px;
    padding: 3px 5px;
    border-radius: 3px;
    background: #f0f0f0;
}

.msg:hover {
    background: #e0e0e0;
}

#auth-container a:hover {
    text-decoration: underline;
}
    </style>
</head>
<body>
<script src="firebase/8.10.0/firebase-app.js"></script>
<script src="firebase/8.10.0/firebase-auth.js"></script>
<script src="firebase/8.10.0/firebase-config.js"></script>
<h3>Гостевая книга v1.1 (Traffic Safe with github Auth)</h3>
<div id="box">Загрузка последних сообщений...</div>
    
<div style="display: flex; gap: 5px;">
    <!-- имя или кнопка -->
    <div id="auth-container">
        <button onclick="login()">Войти через GitHub</button>
    </div>
    <input id="m" placeholder="Сообщение..." style="flex-grow: 1;">
    <button onclick="send()">ОК</button>
</div>
    
<!-- Сначала конфиг -->
<script>
//require('dotenv').config();
//const dbUser = process.env.apiKey;
    // Инициализация
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

    const base = firebaseConfig.databaseURL + "/test.json";
    let userToken = null;
    let userName = "Аноним";
    let lastTs = 0;
    let isFirstLoad = true;
    let isSignedOut = false; // Флаг выхода, обход проблемки

    //<!-- Обновлённый блок авторизации -->
    firebase.auth().onAuthStateChanged(async (user) => {
        const authContainer = document.getElementById("auth-container");
        const messageInput = document.getElementById("m");
        const sendButton = document.querySelector("button[onclick='send()']");
    
        if (user) {
            isSignedOut = false; // Сбрасываем флаг при входе
            userToken = await user.getIdToken();
            userName = user.displayName || user.email.split('@')[0];
            
            authContainer.innerHTML = `
                <a href="#" onclick="handleSignOut()" 
                   style="text-decoration: none; color: inherit; cursor: pointer;"
                   title="Кликните для выхода">
                    ${escape(userName)}
                </a>
            `;
            
            messageInput.disabled = false;
            sendButton.disabled = false;
        } else {
            authContainer.innerHTML = `
                <button onclick="login()">
                    Вход через GitHub
                </button>
            `;
            
            messageInput.disabled = true;
            sendButton.disabled = true;
        }
    });

    async function login() {
        const provider = new firebase.auth.GithubAuthProvider();
        try {
            await firebase.auth().signInWithPopup(provider);
        } catch (e) {
            alert("Ошибка входа: " + e.message);
        }
    }

    async function load() {
        // Параметры для REST
        let params = isFirstLoad 
            ? `orderBy="ts"&limitToLast=10` 
            : `orderBy="ts"&startAt=${lastTs + 1}`;

        const url = `${base}?${params}`;

        try {
            const res = await fetch(url);
            if (!res.ok) {
                const err = await res.json();
                console.warn("Firebase busy/restricted:", err.error);
                return;
            }
            const data = await res.json();
            const box = document.getElementById("box");

            if (data && typeof data === 'object') {
                if (isFirstLoad) { box.innerHTML = ""; isFirstLoad = false; }
            const sortedIds = Object.keys(data).sort((a, b) => data[a].ts - data[b].ts);
            sortedIds.forEach(id => {
                const d = data[id];
                if (!d || !d.ts || d.ts <= lastTs) return;
                
                const div = document.createElement("div");
                div.className = "msg";
                const time = new Date(d.ts).toLocaleTimeString();
                const date = new Date(d.ts).toLocaleDateString();
                
                // Переносим метаданные в title
                div.title = `${date} ${time} | ${escape(d.name || 'Anonymous')}`;
                div.innerHTML = escape(d.text); // Только текст сообщения
                
                box.appendChild(div);
                lastTs = d.ts;
            });
            box.scrollTop = box.scrollHeight;
            }
        } catch (e) { console.error("Network error"); }
    }
// Обработчик выхода
function handleSignOut() {
    firebase.auth().signOut().then(() => {
        isSignedOut = true;
        document.getElementById("m").disabled = true;
        document.querySelector("button").disabled = true;
    });
    return false; // Отменяем действие ссылки
}
// Отправка в чат (и в базу rtdb) с авторизацией и меткой времени [ts]
    async function send() {
        let text = document.getElementById("m").value;
        if (!text.trim()) return;
        if (!userToken) { alert("Сначала войдите через GitHub!"); return; }
        if (isSignedOut || !firebase.auth().currentUser) {alert('Сессия завершена, обновите страницу'); return; }
        try {
            const res = await fetch(`${base}?auth=${userToken}`, {
                method: 'POST',
                body: JSON.stringify({
                    name: userName,
                    text: text,
                    ts: Date.now()
                })
            });
            if (!res.ok) throw new Error();
            document.getElementById("m").value = "";
            load();
        } catch (e) { alert("Ошибка записи в бвзу. Проверьте Rules!"); }
    }

    function escape(str) {
        if (!str) return "";
        return String(str).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }

    setInterval(load, 12000);
    load();
</script>
</body>
</html>
